//https://gist.github.com/popcorn245/30afa0f98eea1c2fd34d


struct RGBW {
    uint8_t r;
    uint8_t g;
    uint8_t b;
    uint8_t w;
};


float max_of_two(float x, float y) {
    return (x > y) ? x : y;
}

float max_of_three(float m, float n, float p) {
    return max_of_two(max_of_two(m, n), p);
}

RGBW colorxyToRGBW(float color_x, float color_y, uint8_t brightness) {
    float x = color_x/65536;
    float y = color_y/65536;
    float z = 1.0f - x - y;
    Serial.print(F("z: "));
    Serial.print(x, DEC);
    Serial.print(F(" y: "));
    Serial.print(y, DEC);
    Serial.print(F(" z: "));
    Serial.println(y, DEC);
    float Y = brightness/255.0;
    float X = (Y/y) * x;
    float Z = (Y/y) * z;
    /*
    float r = X * 1.612 - Y * 0.203 - Z * 0.302;
    float g = -X * 0.509 + Y * 1.412 + Z * 0.066;
    float b = X * 0.026 - Y * 0.072 + Z * 0.962;
    */
    float r = X * 1.4628067f - Y * 0.1840623f - Z * 0.2743606f;
    float g = -X * 0.5217933f + Y * 1.4472381f + Z * 0.0677227f;
    float b = X * 0.0349342f - Y * 0.0968930f + Z * 1.2884099f;

    /*
    r = r <= 0.0031308 ? 12.92 * r : (1.0 + 0.055) * pow(r, (1.0 / 2.4)) - 0.055;
    g = g <= 0.0031308 ? 12.92 * g : (1.0 + 0.055) * pow(g, (1.0 / 2.4)) - 0.055;
    b = b <= 0.0031308 ? 12.92 * b : (1.0 + 0.055) * pow(b, (1.0 / 2.4)) - 0.055;
    */

    r = r <= 0.0031308f ? 12.92f * r : (1.0f + 0.055f) * pow(r, (1.0f / 2.4f)) - 0.055f;
    g = g <= 0.0031308f ? 12.92f * g : (1.0f + 0.055f) * pow(g, (1.0f / 2.4f)) - 0.055f;
    b = b <= 0.0031308f ? 12.92f * b : (1.0f + 0.055f) * pow(b, (1.0f / 2.4f)) - 0.055f;


    float maxValue = max_of_three(r,g,b);
    Serial.print(F("Max: "));
    Serial.println(maxValue, DEC);

    r /= maxValue;
    g /= maxValue;
    b /= maxValue;
    r = r * 255;
    if (r < 0) { r = 255; };
    g = g * 255;
    if (g < 0) { g = 255; };
    b = b * 255;
    if (b < 0) { b = 255; };


/*
    float r = X * 1.4628067f - Y * 0.1840623f - Z * 0.2743606f;
    float g = -X * 0.5217933f + Y * 1.4472381f + Z * 0.0677227f;
    float b = X * 0.0349342f - Y * 0.0968930f + Z * 1.2884099f;

    

    if (r < 0) {
      r = 0;
    }
    if (g < 0) {
      g = 0;
    }
    if (b < 0) {
      b = 0;
    }
*/
    RGBW result;
    result.r = (uint8_t)r;
    result.g = (uint8_t)g;
    result.b = (uint8_t)b;
    Serial.print(F("R: "));
    Serial.print(result.r, DEC);
    Serial.print(F(" G: "));
    Serial.print(result.g, DEC);
    Serial.print(F(" B: "));
    Serial.print(result.b, DEC);
    //Serial.print(F(" W: "));
    //Serial.print(w, DEC);
    Serial.println();
    
    return result;
}
